<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script data-goatcounter="https://todepond.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<title>Pondiverse</title>
<!-- <link rel="shortcut icon" href="/favicon.png" /> -->
<!-- <meta property="og:image" content="https://todepond.com/og.png" /> -->
<!-- <meta property="og:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:card" content="summary_large_image" /> -->
<!-- <meta name="twitter:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:description" content="" /> -->
<!-- <meta name="twitter:image" content="https://todepond.com/og.png" /> -->

<link rel="stylesheet" href="/style.css" />

<h1>Pondiverse</h1>

<header id="view-source" style="position: absolute; top: 0; right: 0; padding: 16px">
  <a href="https://github.com/TodePond/Pondiverse" target="_blank">View source</a>
</header>

<header>
  <p>
    The pondiverse is a network for sharing and exploring creations across many
    places!
  </p>

  <h3><span id="tools-count">Loading...</span> tools | <span id="creations-count">Loading...</span> creations</h3>
</header>

<main>
  <a href="/create/" class="button">Create</a>
  <a href="/explore/" class="button">Explore</a>
  <a href="/learn/" class="button secondary">Learn</a>
</main>

<!-- 
<br />
<br />
<br />
<br />
<br />

<section>
  <a href="/admin/" class="button danger">Admin</a>
</section> -->

<script>
  import { tools } from '/tools.js';
  import { instances } from '/instances.js';
  import { fetchPondiverseCreations } from '/pondiverse.js';

  const toolsCountElement = document.getElementById('tools-count');
  const creationsCountElement = document.getElementById('creations-count');

  async function updateCounts() {
    if (tools && toolsCountElement) {
      toolsCountElement.textContent = tools.length;
    } else if (toolsCountElement) {
      toolsCountElement.textContent = 'Error';
      console.error('Tools data not found or tools count element missing.');
    }

    if (instances && creationsCountElement) {
      creationsCountElement.textContent = 'Calculating...';
      let totalCreations = 0;
      let fetchErrors = 0;

      const creationPromises = instances.map(async (instance) => {
        try {
          const creations = await fetchPondiverseCreations({ instance });
          return creations.length;
        } catch (e) {
          console.error(`Error fetching creations from ${instance.name}:`, e);
          fetchErrors++;
          return 0;
        }
      });

      try {
        const countsPerInstance = await Promise.all(creationPromises);
        totalCreations = countsPerInstance.reduce((sum, count) => sum + count, 0);

        if (fetchErrors > 0 && fetchErrors === instances.length) {
          creationsCountElement.textContent = 'Error fetching all';
        } else if (fetchErrors > 0) {
          creationsCountElement.textContent = `${totalCreations} (some instances failed)`;
        } else {
          creationsCountElement.textContent = totalCreations;
        }
      } catch (error) {
        console.error('Error processing creation counts:', error);
        creationsCountElement.textContent = 'Error';
      }

    } else if (creationsCountElement) {
      creationsCountElement.textContent = 'Error';
      console.error('Instances data not found or creations count element missing.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateCounts();
  });
</script>